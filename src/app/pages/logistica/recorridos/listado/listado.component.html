<div class="sm:ml-52 py-8 px-2  ">
   <div class="p-2    rounded-lg  h-full  dark:border-gray-700 mt-8 transition-colors duration-30 ">
      <div class="flex justify-between items-center w-full p-2 bg-transparent dark:bg-gray-500 rounded-tr-md rounded-tl-md text-gray-600 dark:text-white">
         <h1 class="text-2xl ">Recorridos</h1>
         
         <div class="flex items-center space-x-2">         
            <button (click)="toogleRecorridosPendientes()" [disabled]="cargando()" class="text-sm  p-2 bg-blue-600 hover:bg-slate-700 text-white rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800  disabled:bg-gray-300 disabled:text-gray-800 disabled:cursor-not-allowed *:disabled:opacity-50">
               <span>Mostrar {{!mostrarRecorridosPendientes()?'solicitudes':'recorridos'}}</span>            
            </button>
            <button (click)="descargarExcel()"  class="text-md rounded-full border p-2 border-black dark:border-white hover:bg-green-500 dark:hover:bg-green-500 hover:text-white">
               <svg class="fill-current w-5 h-5" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path d="M439.658,91.21L351.435,2.987C349.522,1.075,346.928,0,344.223,0H79.554c-5.633,0-10.199,4.566-10.199,10.199v491.602 c0,5.633,4.566,10.199,10.199,10.199h352.892c5.632,0,10.199-4.566,10.199-10.199V98.422 C442.645,95.717,441.57,93.123,439.658,91.21z M354.422,34.823l53.401,53.4h-53.401V34.823z M422.247,491.602H89.753V20.398 h244.271v78.024c0,5.633,4.567,10.199,10.199,10.199h78.024V491.602z"></path> </g> </g> <g> <g> <path d="M282.012,454.884H119.331c-5.633,0-10.199,4.566-10.199,10.199s4.566,10.199,10.199,10.199h162.681 c5.632,0,10.199-4.566,10.199-10.199S287.644,454.884,282.012,454.884z"></path> </g> </g> <g> <g> <path d="M334.026,454.884h-11.067c-5.632,0-10.199,4.566-10.199,10.199s4.567,10.199,10.199,10.199h11.067 c5.632,0,10.199-4.566,10.199-10.199S339.658,454.884,334.026,454.884z"></path> </g> </g> <g> <g> <path d="M311.6,263.139l75.737-93.534c2.473-3.056,2.972-7.261,1.278-10.809c-1.692-3.549-5.274-5.808-9.205-5.808h-84.952 c-3.078,0-5.99,1.389-7.926,3.781L256,194.475l-30.532-37.706c-1.936-2.392-4.849-3.781-7.926-3.781H132.59 c-3.931,0-7.513,2.259-9.206,5.808c-1.693,3.548-1.194,7.754,1.279,10.809l75.737,93.534l-75.737,93.534 c-2.474,3.056-2.972,7.261-1.279,10.809c1.693,3.548,5.274,5.808,9.206,5.808h84.952c3.077,0,5.99-1.389,7.926-3.781L256,331.804 l30.531,37.706c1.936,2.392,4.849,3.781,7.926,3.781h84.953c3.931,0,7.513-2.259,9.205-5.808 c1.693-3.548,1.195-7.754-1.279-10.809L311.6,263.139z M299.323,173.386h58.706l-59.553,73.545l-29.352-36.25L299.323,173.386z M212.677,352.892h-58.706l59.552-73.545l29.352,36.25L212.677,352.892z M299.323,352.892L153.971,173.386h58.706l145.351,179.506 H299.323z"></path> </g> </g> </g></svg>
            </button>                     
         </div>
      
         
         
      </div>      
      <div class="w-full mb-4">           
         @if (cargando())  {
            <div>
               <div class="animate-pulse flex space-x-4">
                  <div class="flex-1 space-y-4 py-1">
                     <div class="h-4 bg-gray-300 dark:bg-gray-700 rounded w-3/4"></div>
                     <div class="space-y-2">
                        <div class="h-4 bg-gray-300 dark:bg-gray-700 rounded"></div>
                        <div class="h-4 bg-gray-300 dark:bg-gray-700 rounded w-5/6"></div>
                     </div>
                  </div>
               </div>
            </div>            
         }@else{



       


            <ejs-grid #grid [dataSource]='Recorridos()' 
            [filterSettings]="filterSettings" 
            (dataBound)='dataBound()'
            [allowExcelExport]='true'
            [height]="heightGrid"
            allowReordering='true'
            [allowFiltering]=true
            allowPaging="true"
            allowResizing="true"
            allowSorting="true"
            [pageSettings]='pageSettings'>
            <e-columns>
               <e-column field='id_recorrido' [allowFiltering]="false" headerText='' width=70> >
                  <ng-template #template let-data>
                     <div  class="grid grid-cols-3 gap-4">
                        
                        <svg  (click)="mostrarDetalleRecorrido(data)" class="h-4 w-4 cursor-pointer stroke-slate-950 dark:stroke-white" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5c-4.142 0-7.5 3.358-7.5 7.5s3.358 7.5 7.5 7.5 7.5-3.358 7.5-7.5-3.358-7.5-7.5-7.5z" />
                           <path stroke-linecap="round" stroke-linejoin="round" d="M12 9a3 3 0 100 6 3 3 0 000-6z" />
                         </svg>
                           

                        @if(data.tipo=='externo'){
                           <svg class="h-4 w-4 cursor-pointer stroke-slate-950 dark:stroke-white " (click)="showEditDialog(data)"  viewBox="0 0 24 24" fill="none" 
                           xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> 
                              <path d="M21.2799 6.40005L11.7399 15.94C10.7899 16.89 7.96987 17.33 7.33987 16.7C6.70987 16.07 7.13987 13.25 8.08987 12.3L17.6399 2.75002C17.8754 2.49308 18.1605 2.28654 18.4781 2.14284C18.7956 1.99914 19.139 1.92124 19.4875 1.9139C19.8359 1.90657 20.1823 1.96991 20.5056 2.10012C20.8289 2.23033 21.1225 2.42473 21.3686 2.67153C21.6147 2.91833 21.8083 3.21243 21.9376 3.53609C22.0669 3.85976 22.1294 4.20626 22.1211 4.55471C22.1128 4.90316 22.0339 5.24635 21.8894 5.5635C21.7448 5.88065 21.5375 6.16524 21.2799 6.40005V6.40005Z" stroke="current" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M11 4H6C4.93913 4 3.92178 4.42142 3.17163 5.17157C2.42149 5.92172 2 6.93913 2 8V18C2 19.0609 2.42149 20.0783 3.17163 20.8284C3.92178 21.5786 4.93913 22 6 22H17C19.21 22 20 20.2 20 18V13" stroke="current" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>                     
                        }
                        @if(data.esUltimo=='1'){
                           <svg  (click)="eliminarRecorrido(data)"  class="h-4 w-4 cursor-pointer   fill-current " viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" ><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path  d="M160 256H96a32 32 0 0 1 0-64h256V95.936a32 32 0 0 1 32-32h256a32 32 0 0 1 32 32V192h256a32 32 0 1 1 0 64h-64v672a32 32 0 0 1-32 32H192a32 32 0 0 1-32-32V256zm448-64v-64H416v64h192zM224 896h576V256H224v640zm192-128a32 32 0 0 1-32-32V416a32 32 0 0 1 64 0v320a32 32 0 0 1-32 32zm192 0a32 32 0 0 1-32-32V416a32 32 0 0 1 64 0v320a32 32 0 0 1-32 32z"></path></g></svg>                           
                        }
                        
                     </div>
                     
                  </ng-template>
               </e-column>
               <!-- <e-column field='factura' headerText="Factura" /> -->
               <!-- <e-column field='importe_factura' headerText="Importe" width='150'>
                  <ng-template #template let-data>
                     {{data.importe_factura | currency}}
                  </ng-template>
                  <ng-template #editTemplate let-data>
                     <input class="e-input" type="text">
                  </ng-template>
               </e-column> -->
               <!-- <e-column field='costo_viaje' headerText="Costo de envio" >
                  <ng-template #template let-data>
                     {{data.costo_viaje| currency}}
                  </ng-template>
               </e-column>                   -->

               <e-column field='tipoRecorrido' headerText="Tipo" width=80>
                  <ng-template #template let-data>
                     {{data.tipoRecorrido | uppercase}}
                  </ng-template>
               </e-column>
               
               <e-column field='nombre_chofer' headerText='chofer'  width=150></e-column>
               <e-column field='descripcion_transporte' headerText='transporte'  width=100></e-column>
               <e-column field='descripcion_tipo_servicio' headerText="Servicio" width=110 ></e-column>
               <e-column field='destino'   width=150/>
               <e-column field='opsAsignadas' headerText="Op"  width=120></e-column>
               <!-- <e-column field='remisionesAsignadas' headerText="Remisión"></e-column> -->
               <e-column field='kilometraje_inicial' headerText="Inicial"   width=110>
                  <ng-template #template let-data>
                     @if (data.tipo=='interno' && !data.kilometraje_inicial){
                        <h1 class="border rounded px-1 text-center text-white  bg-amber-500">PENDIENTE</h1>
                     }@else{
                        {{data.kilometraje_inicial ??'N/A'}}
                     }                     
                  </ng-template>
               </e-column>
               <e-column field='kilometraje_final' headerText="Final"  width=110 >
                  <ng-template #template let-data>
                     @if (data.tipo=='interno' && !data.kilometraje_final){
                        <h1 class="border rounded px-1 text-white text-center  bg-amber-500">PENDIENTE</h1>
                     }@else{
                        {{data.kilometraje_final ??'N/A'}}
                     }
                     
                  </ng-template>
               </e-column>
               <e-column field='kilometros' headerText="kilometros"  width=80></e-column>
               <e-column field='fecha_salida' headerText="Salida"   width=140>
                  <ng-template #template let-data>
                     @if(data.tipo=='interno'){
                        @if (!data.fecha_salida){
                        <h1 class="border rounded text-center px-1 max-w-20 text-white  bg-amber-500">PENDIENTE</h1>
                        }@else{
                           {{data.fecha_salida ? (data.fecha_salida | date: 'dd-MM-yyyy HH:mm '):'N/A' }}
                        }                     
                     }@else{
                     {{data.fecha_salida ? (data.fecha_salida | date: 'dd-MM-yyyy'):'N/A' }}
                     }
                  </ng-template>
               </e-column>
               <e-column field='fecha_regreso' headerText="Regreso" allowEditing="false"  width=140 >
                  <ng-template #template let-data>
                     @if(data.tipo=='interno' && !data.fecha_salida){                        
                        <h1 class="border rounded text-center px-1 max-w-20 text-white bg-amber-500">PENDIENTE</h1>
                        }@else{
                           {{data.fecha_regreso ? (data.fecha_regreso | date: 'dd-MM-yyyy HH:mm'):'N/A' }}
                        }                     
                  </ng-template>
               </e-column>
                           
               <e-column field="fechaFirma" headerText="Fecha firma"  [allowFiltering]="false"  width=150>
                  <ng-template #template let-data>                  
                        {{data.fechaFirma | date: 'dd-MM-yyyy HH:mm'}}                  
                     </ng-template>
               </e-column>
            <e-column headerText="GPS"   width=60>
               <ng-template #template let-data>
               <gps-position-svg (click)="mostrarUbicaciones(data)"/>
               </ng-template>
            </e-column>
            
            </e-columns>
           </ejs-grid>
         }       
      </div>
   </div>
   <app-fabbutton></app-fabbutton>
   <p-dialog header="Editar información" [visible]="visibleEditarInfo()" [style]="{ width: '25rem' }" 
      (onHide)="hideEditDialog()"
      (visibleChange)="visibleChange($event)"
      >
      @if(recorridoActivo){
      <div class="flex flex-col gap-3 mt-2 ">
         <div class="flex space-x-4 items-center">
            <label for="factura">Factura</label>
            <input id="factura" maxlength="20" [(ngModel)]="recorridoActivo.factura"
               class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
               placeholder="Factura" autocomplete="off" />
         </div>
         <div class="flex space-x-4 items-center ">
            <label for="importe" autocomplete="off">Importe</label>
            <input id="importe" [(ngModel)]="recorridoActivo.importe_factura" maxlength="20"
            (input)="onInput($event,'')"
            (keypress)="onValidateNumber($event)" 

               class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
               placeholder="Importe" autocomplete="off" />
         </div>
      </div>
      }
      <div class="flex  justify-end  ">
         <button label="Save"
            class="mt-6 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800"
            (click)="save()">Guardar</button>
      </div>
   </p-dialog>

   <p-dialog header="Ubicaciones registradas" [visible]="visibleUbicaciones()" 
      (onHide)="hideUbicacionesDialog()"
      (visibleChange)="ubicacionDialogChange($event)"
      [style]="{ width: '50rem', height:'auto' }" 
      [modal]="true"
      [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
      >      
      @if(firma) {
         <div class="relative z-50 mt-4  rounded-md ">
             <div class="absolute top-2 right-2 flex flex-col items-center bg-white dark:bg-slate-600 p-2 rounded-md shadow-md">
                 <label class="text-[11px] font-medium text-gray-700 dark:text-white ">Firma de recibido</label>
                 <label class="text-[11px] text-gray-500  dark:text-white">{{ firma.fecha_registro | date: 'dd-MM-yyyy hh:mm a' }}</label>
                 <div class="w-20 h-16 overflow-hidden">
                  <img [src]="firma.imagen" alt="Firma" class="w-full h-auto object-cover rounded-md mt-2 dark:invert" style="transform: scale(1); transform-origin: top left;"/>
              </div>
             </div>
                      
         </div>
     }
      <div class=" flex  flex-col justify-between mt-4">     
         @if (!cargandoUbicaciones() && !ubicacionesRecorrido.inicial && !ubicacionesRecorrido.final ) {
            <div class="text-center">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z" />
               </svg>
               <p class="text-gray-500 mt-2">No hay ubicaciones registradas</p>
             </div>
         } 
         @if(ubicacionesRecorrido.final) { 
            <div class="relative  w-full mt-4 border-2 border-slate-400 rounded-sm  " >
              <h1 class="absolute top-2 left-1 text-sm font-medium text-white bg-slate-600 px-2 rounded-md ">Posición aproximada de fin</h1>
              <img [src]="ubicacionesRecorrido.final" alt="Mapa de Mapbox" class="w-full h-full rounded-sm cursor-pointer"  (click)="irUbicacionGooleMaps(ubicacionesRecorrido.final)">
              <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                <img src="assets/img/marker.svg" class="w-6 h-6" />
              </div>
            </div>         
           }      
         @if(ubicacionesRecorrido.inicial) { 
         <div class="relative  w-full mt-4 border-2 border-slate-400 rounded-sm  ">
            <h1 class="absolute top-2 left-1 text-sm font-medium text-white bg-slate-600 px-2 rounded-md ">Posición aproximada de inicio</h1>
            <img [src]="ubicacionesRecorrido.inicial" alt="Mapa de Mapbox" class="w-full h-full rounded-sm cursor-pointer" (click)="irUbicacionGooleMaps(ubicacionesRecorrido.inicial)">
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
              <img src="assets/img/marker.svg" class="w-6 h-6 " />
            </div>
          </div>         
         }
       
         </div>      
   </p-dialog>



   <p-dialog [(visible)]="detalleRecorridoVisible" [style]="{ width: '50vw' }" [modal]="true" [closable]="true" (onHide)="cerrarDetalleRecorrido()">
      <ng-template pTemplate="headless">
         
         <div *ngIf="recorridoSeleccionado" class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg shadow-md">
            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4">Información del Recorrido</h3>
            <div class="grid  gap-4 items-center"  [class]="recorridoSeleccionado.personalChofer!=0 ? 'grid-cols-3 ' : 'grid-cols-2'">
               <!-- Foto del chofer -->
                @if(recorridoSeleccionado.personalChofer!=0){            
               <div class="col-span-1 flex justify-center">
                  <img [src]="recorridoSeleccionado.fotoChofer" alt="Foto del Chofer" class="w-24 h-24 rounded-full shadow-md object-cover dark:border-gray-700">
               </div>
            }
               <!-- Detalles del recorrido -->
               <div class="col-span-2 grid grid-cols-2 gap-4">
                  <div>
                     <p class="text-sm font-medium text-gray-600 dark:text-gray-300">ID:</p>
                     <p class="text-base text-gray-800 dark:text-gray-100">{{ recorridoSeleccionado.id_recorrido }}</p>
                  </div>
                  <div>
                     <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Chofer:</p>
                     <p class="text-base text-gray-800 dark:text-gray-100">{{ recorridoSeleccionado.nombre_chofer }}</p>
                  </div>
                  <div>
                     <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Transporte:</p>
                     <p class="text-base text-gray-800 dark:text-gray-100">{{ recorridoSeleccionado.descripcion_transporte }}</p>
                  </div>
                  <div>
                     <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Destino:</p>
                     <p class="text-base text-gray-800 dark:text-gray-100">{{ recorridoSeleccionado.destino }}</p>
                  </div>
                  <div>
                     <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Factura:</p>
                     <p class="text-base text-gray-800 dark:text-gray-100">{{ recorridoSeleccionado.factura }}</p>
                  </div>
                  <div>
                     <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Importe factura:</p>
                     <p class="text-base text-gray-800 dark:text-gray-100">{{ recorridoSeleccionado.importe_factura | currency }}</p>
                  </div>
                  <div>
                     <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Costo de envío:</p>
                     <p class="text-base text-gray-800 dark:text-gray-100">{{ recorridoSeleccionado.costo_viaje ?? 0 | currency }}</p>
                  </div>
                  <div>
                     <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Remisión:</p>
                     <p class="text-base text-gray-800 dark:text-gray-100">{{ recorridoSeleccionado.remisionesAsignadas }}</p>
                  </div>
                  <div>
                     <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Observaciones:</p>
                     <p class="text-base text-gray-800 dark:text-gray-100">{{ recorridoSeleccionado.observaciones }}</p>
                  </div>
               </div>
            </div>
            <div class="mt-6 flex justify-end">
               <button (click)="cerrarDetalleRecorrido()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                  Cerrar
               </button>
            </div>
         </div>
      </ng-template>
   </p-dialog>